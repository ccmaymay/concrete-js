<!DOCTYPE html>
<html lang="en">
<head>
  <title>concrete-js examples</title>
  <meta charset='UTF-8'>

  <link rel="stylesheet" href="bootstrap-3.2.0/css/bootstrap.css"/>
  <link rel="stylesheet" href="bootstrap-3.2.0/css/bootstrap-theme.css"/>
  <link rel="stylesheet" href="examples.css"/>

  <script src="jquery-1.11.1.js"></script>
  <script src="bootstrap-3.2.0/js/bootstrap.js"></script>

  <script src="thrift.js"></script>
  <script src="concrete.js"></script>

  <script src="tokentagging_ui.js"></script>

  <style>
  .container-fluid {
      margin-left: 1em;
      margin-right: 1em;
  }

  .tag_text_li {
      display: inline;
  }
  .tag_text_input {
      margin-right: 1em;
      width: 8em;
  }

  .token_tagging_container {
      border: 1px solid 888;
      padding-bottom: 2em;
  }

  /** Hide tokenTags. This can be commented out for debugging purposes.**/
  .tokenTag {
      display: none;
  }

   /** Create classes for BIO tags. **/
  .token_tag_type_B {
      cursor: pointer;
      font-weight: bold
  }
  .token_tag_type_I {
      cursor: pointer;
      font-style: italic
  }
  .token_tag_type_O {
      cursor: pointer;
  }
  </style>

  <script>
  function displayErrorMessage(message) {
    $('#error_message_text').text(message);
    $('#error_message_div').show();
  }

  function renderCommunication(comm) {
    $('#tokenization_list').empty();

    var tokenizations = comm.getTokenizationsAsList();
    for (var tokenizationIndex = 0; tokenizationIndex < tokenizations.length; tokenizationIndex++) {
      var tokenization = tokenizations[tokenizationIndex];

      if (tokenization) {
        var tokensDiv = $('<div>').attr('id', 'comm_' + tokenizationIndex + '_tokens');
        var tokenTagInputsDiv = $('<div>').attr('id', 'comm_' + tokenizationIndex + '_ne_inputs');

        var tokenTagging;
        var tokenTaggingIndex = checkForPreviousNERTags(tokenization);

        // If there is a previous NER TokenTagging, it is duplicated.
        if (tokenTaggingIndex !== false) {
          tokenTagging = duplicateTokenTagging(tokenization, tokenTaggingIndex, "NER");
        }
        // If there is not a previous NER TokenTagging, a new one is created
        // and initialized with "O" tags for all tokens.
        else {
          tokenTagging = createTokenTagging("NER");
          setAllTokenTagsToO(tokenization, tokenTagging);
        }
        addTokenTagging(tokenization, tokenTagging);
        for (var tokenIndex in tokenization.tokenList.tokenList) {
          var tokenTag = getTaggedTokenWithIndex(tokenTagging,tokenIndex).tag;
          var foo = tagSet.indexOf(tokenTag.split("-").pop());
          var token_span = $('<span>')
            .addClass(getCSSClassForTag(tokenTagging, tokenIndex))
            .attr('data-tag-type-index', foo)
            .attr('id', 'comm_' + tokenizationIndex + '_token_' + tokenIndex)
            .css('background-color', tagColorPairs[foo])
            .click({'commIndex': tokenizationIndex,
                    'tokenization': tokenization,
                    'tokenIndex': tokenIndex,
                    'tokenTagging': tokenTagging},
                   updateTagForNECallback)
            .html(tokenization.tokenList.tokenList[tokenIndex].text + '<span class="tokenTag">(' + tokenTag +')</span>');
          tokensDiv.append(token_span);
          var token_whitespace = $('<span>').text(' ');
          tokensDiv.append(token_whitespace);

          // For each token, create an (initially empty) container where an
          // NE label control can be displayed.
          tokenTagInputsDiv.append(
            $('<div>')
              .attr('id', 'comm_' + tokenizationIndex + '_token_' + tokenIndex + '_ne_input_container'));
          // Add NE label control for all "B" tokens and intializes with the correct value based on its tag.
          if (tokenTag.charAt(0)=="B") {
            tokenTagInputsDiv.append(
              createNEInputControlDiv(tokenizationIndex, tokenization, tokenIndex, tokenTagging, tagSet));
          }
        }
        var tokenTaggingDiv = $('<div>').addClass('token_tagging_container')
                                        .append(tokensDiv)
                                        .append(tokenTagInputsDiv);
        $('#tokenization_list').append(tokenTaggingDiv);
      }
    }
  }

  function renderTagTextBoxes() {
    function addTagTextBox(tagIndex) {
      $('#tag_type_list').append(
        $('<li>').addClass('tag_text_li')
                 .append(
                   $('<input>').addClass('tag_text_input')
                               .attr('type', 'text')
                               .change({'tagSet': tagSet, 'tagIndex':tagIndex}, function(event) {
                                 event.data.tagSet[event.data.tagIndex] = $(this).val();
                               })
                               .val(tagSet[tagIndex])));
    }

    for (var i = 0; i < tagSet.length; i++) {
      addTagTextBox(i);
    }
    $('#tag_type_list').after(
      $('<span>').addClass('glyphicon glyphicon-plus')
                 .css('cursor', 'pointer')
                 .on('click', function(event) {
                   tagSet.push('');
                   addTagTextBox(tagSet.length - 1);
                 }));
  }

  function saveTokenTaggedCommunication() {
    if (COMM) {
      var transport = new Thrift.Transport("/store_http_endpoint/");
      var protocol = new Thrift.TJSONProtocol(transport);
      var storeClient = new StoreCommunicationServiceClient(protocol);
      storeClient.store(COMM);
    }
  }

  // Global variable
  var COMM;

  $(document).ready(function() {
    var transport = new Thrift.Transport("/fetch_http_endpoint/");
    var protocol = new Thrift.TJSONProtocol(transport);
    var fetchClient = new FetchCommunicationServiceClient(protocol);

    var fetchAvailable = false;
    try {
      fetchClient.alive();
      fetchAvailable = true;
    }
    catch (e) {
      // If Fetch is unavailable, ignore expected exception
      if (e !== "encountered a unknown request status: 0") {
        throw e;
      }
    }

    if (fetchAvailable) {
      $('#document_list_button').show();

      var commID = concrete.util.getURLParameter('id');

      if (commID) {
        var fetchRequest = new FetchRequest({communicationIds: [commID]});
        var fetchResult = fetchClient.fetch(fetchRequest);
        comm = fetchResult.communications[0];
        if (comm) {
          renderTagTextBoxes();
          renderCommunication(comm);

          // Save Communication to global variable
          COMM = comm;
        }
        else {
          displayErrorMessage('Unable to Fetch Communication with ID "' + commID + '"');
        }
      }
      else {
        // Display list of Communication IDs and instructions

        $('#tokenization_ui_instructions').hide();
        $('#save_button').hide();
        $('#communication_list_instructions').show();

        var communicationIDs = fetchClient.getCommunicationIDs(0, fetchClient.getCommunicationCount());
        for (var i = 0; i < communicationIDs.length; i++) {
          $('#communication_id_list').append(
            $('<span>').addClass('communication_id_item')
                       .append(
                         $('<a>').attr('href', '?id=' + communicationIDs[i])
                                 .text(communicationIDs[i])));
        }
      }

    }
    else {
      // If Fetch server is unavailable, retrieve JSON file from current directory
      $.getJSON('weibo.comm.json', function(commJSONData) {
        var comm = new Communication();
        comm.initFromTJSONProtocolObject(commJSONData);
        renderSentences(comm);
      });
    }

    $('#save_button').click(saveTokenTaggedCommunication);
  });
  </script>
</head>
<body>
  <div class="container-fluid">
    <div style="padding-top: 1em;">
      <a id="document_list_button" type="button" class="btn btn-default" href="?" style="display: none;">
        Document List
      </a>
      <button id="save_button" type="button" class="btn btn-default">Save</button>
    </div>

    <div id="error_message_div" class="alert alert-danger" style="display: none; margin-top: 1em;">
      <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
      <span id="error_message_text"></span>
    </div>

    <div style="padding-top: 1em;">
      <h2>Manual tokenization UI example</h2>
      <div id="tokenization_ui_instructions">
        <p>
          Use tab, shift-tab, or the arrow keys to move the focus between two characters.

          To connect characters into multi-character tokens, press the 'x' key
          or double-click the space between characters.
        </p>
      </div>
      <div>
        <div>
            <span id="tag_type_list"></span>
        </div>
        <div id="tokenization_list"></div>
      </div>
    </div>

    <hr />

    <div id="communication_list_instructions" style="display: none;">
      <p>
        Please select the Communication that you want to annotate with Named Entities:
      </p>
      <div id="communication_id_list"></div>
    </div>
  </div>
</body>
</html>
