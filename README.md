# concrete-js

[![Build status](https://github.com/hltcoe/concrete-js/actions/workflows/node.js.yml/badge.svg)](https://github.com/hltcoe/concrete-js/actions/workflows/node.js.yml)

**concrete-js** is a Node.js/JavaScript library for working with
[Concrete](https://github.com/hltcoe/concrete), a set of NLP data
types defined by a [Thrift](https://thrift.apache.org) schema.  Thrift
makes it easy to use a shared set of data structures across multiple
programming languages.

**concrete-js** is designed for visualization and annotation.  While
it is *technically* possible to implement NLP algorithms in
JavaScript, consider using
[concrete-python](https://github.com/hltcoe/concrete-python) or
[concrete-java](https://github.com/hltcoe/concrete-java)
instead.

In general, you should use **concrete-js** when you have a Concrete
*Communication* object that was created by another tool, and need a UI
that visually represents data in the *Communication*.  You may also
need the user/annotator to interactively modify Concrete data
structures and then save their modifications.

The **concrete-js** library contains serialization and deserialization
code for Concrete data structures that is generated by Thrift according
to [the Concrete schema](http://hltcoe.github.io/concrete/schema/).
The library also contains utility code for working with Concrete
objects.

See [the API documentation](http://hltcoe.github.io/concrete-js/) for a
detailed description of the **concrete-js** library's contents.



## Node.js

The Node.js library is published as `@ccmaymay/concrete`.


### Including @ccmaymay/concrete in your project

To use concrete in your Node.js project, use `npm install` to add it to
your dependencies:

```
npm install @ccmaymay/concrete
```

Then, to define a function that retrieves the first ten Communications
from a Concrete Fetch service (for example):

```javascript
import thrift from "thrift";
import concrete from "@ccmaymay/concrete";

/**
 * Creates and returns a Fetch client for an HTTP Fetch service.
 *
 * @param host Host name or IP of HTTP Fetch service
 * @param port TCP port of HTTP Fetch service
 * @param path URL path of HTTP Fetch service
 * @returns Fetch client
 */
async createFetchClient(host, port = 8000, path = '/') {
  const options = {
    transport: thrift.TBufferedTransport,
    protocol: thrift.TJSONProtocol,
    path: path,
    https: false,
  };
  const connection = thrift.createXHRConnection(
    host,
    port,
    options
  );
  connection.on("error", function (err) {
    console.error(err);
  });
  return thrift.createXHRClient(
    concrete.access.FetchCommunicationService,
    connection
  );
}

/**
 * Returns up to the first ten Communications from a Fetch service.
 *
 * @param fetchClient A Fetch client for the desired Fetch service
 * @param maxNumCommunications The maximum number of Communications to
 *   retrieve
 * @returns A list of maxNumCommunications Communications (or fewer
 *   if the Fetch client does not have that many Communications).
 */
async headCommunications(fetchClient, maxNumCommunications = 10) {
  const numCommunications = await fetchClient.getCommunicationCount();
  const communicationIds = await fetchClient.getCommunicationIDs(
    0,
    Math.min(maxNumCommunications, numCommunications)
  );
  const request = new concrete.access.FetchRequest({
    communicationIds: communicationIds,
  });
  const result = await fetchClient.fetch(request);
  return result.communications;
}
```


## JavaScript with JQuery

The JavaScript + jQuery **concrete-js** library contains the
serialization, deserialization, networking, and utility code available
in the Node.js library as well as additional visualization code that
maps Concrete data structures to DOM elements using
[jQuery](http://jquery.com).


### Including concrete-js in your project

In order to use **concrete-js**, you will need jQuery version 1.9 or
later, and the files `dist/thrift.js` and `dist/concrete.js`.  You
do not need any of the files in the `src/` directory.  Those files
are concatenated together to create `dist/concrete.js`.

In your HTML file, you should include the scripts in this order:

```html
<script src="your/copy/of/jquery.js"></script>
<script src="thrift.js"></script>
<script src="concrete.js"></script>
```

If you want to access the JavaScript libraries from a CDN, use:

```html
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://hltcoe.github.io/concrete-js/thrift.js"></script>
<script src="https://hltcoe.github.io/concrete-js/concrete.js"></script>
```


### Fetching Communications with JavaScript

There are two primary ways to load Concrete Communications into
JavaScript - Thrift RPC (Remote Procedure Calls) and HTTP GET requests
for JSON serialized Communications.  The JavaScript version of Thrift
only supports the *TJSONProtocol* serialization protocol.

The `Communication` class in **concrete-js** has been extended with
some helper functions for working with TJSONProtocol.  Here is an
example of how to retrieve a JSON-serialized Communication with a GET
request using jQuery:

```javascript
// When the page has loaded...
$(document).ready(function() {
  // ...make an HTTP GET request to retrieve a JSON-serialized Communication...
  $.getJSON('dog-bites-man.concrete.json', function(commJSONData) {
    // ...and call this (unnamed) callback function with the JSON data.

    // Create an empty Concrete Communication object
    var commOne = new Communication();

    // Load JSON-serialized Communication data into Communication object
    commOne.initFromTJSONProtocolObject(commJSONData);
```

The `examples/index.html` file uses this technique to retrieve a
Communication.

**concrete-js** provides functions that serialize and deserialize
Communication objects using TJSONProtocol:

```javascript
var comm = new Communication();
var comm_as_json_object = comm.toTJSONProtocolObject();
var comm_as_json_string = comm.toTJSONProtocolString();

var comm2 = new Communication();
comm2.initFromTJSONProtocolObject(comm_as_json_object);

var comm3 = new Communication();
comm3.initFromTJSONProtocolString(comm_as_json_string);
```



## Building concrete-js

You do not need to build **concrete-js** in order to use
**concrete-js**:  The Node.js package is available on the npm registry,
and a working copy of the JavaScript + jQuery library is included in
this repository in the `dist/` directory.  The **concrete-js** library
only needs to be (re)built when the Thrift schema files for Concrete
have been updated or when the code in `src/` is modified.

Requirements for building **concrete-js**:

* A clone of
  [the Concrete schema repository](https://github.com/hltcoe/concrete)
  in your home directory (at `~/concrete`)
* [Thrift](https://thrift.apache.org)
* [Node.js](http://nodejs.org)
  (a JavaScript backend runtime and packaging tool)

First, install the Node.js packages required for building
**concrete-js**:

```
npm install
```

Then build **concrete-js**:

```
npx grunt
```

This command will build both the JavaScript + jQuery and the Node.js version
of the library:

1. Build Node.js library
   * call the Thrift compiler to generate Node.js code for the Thrift schema under `~/concrete`
   * run [JSHint](http://www.jshint.com) on the code to check for problems
   * combine the Thrift-generated code with the hand-written utility code in `dist_nodejs`
   * generate documentation in `docs_nodejs`
2. Build JavaScript + jQuery library
   * call the Thrift compiler to generate JavaScript + jQuery code for the Thrift schema under `~/concrete`
   * run [JSHint](http://www.jshint.com) on the code to check for problems
   * combine the Thrift-generated code with the hand-written utility code in `dist`
   * minify the combined code to reduce download size
   * generate documentation in `docs`
   * download a supported version of `thrift.js` to `dist/thrift.js`


## Testing concrete-js

There are no tests for the Node.js library yet! ðŸ˜±

To run tests for the JavaScript + jQuery library, do:

```
npx grunt test
```


## Publishing @ccmaymay/concrete

After building the Node.js `@ccmaymay/concrete` library using the steps
described previously, the package files will be located in the
`dist_nodejs` subdirectory.  To publish the package to the npm
registry, go to `dist_nodejs` and run `npm publish`:

```
cd dist_nodejs
npm publish
```
